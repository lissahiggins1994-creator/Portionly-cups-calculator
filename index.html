<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portionly Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <img
    src="portionly-logo.png"
    alt="Portionly logo"
    style="max-width:200px; display:block; margin:24px auto;"
  />

  <h1 style="text-align:center;">Portionly Calculator Module</h1>

  <p style="text-align:center;">
    This page exposes <code>window.PortionlyCalculator</code>.<br />
    Open your browser console to try it.
  </p>

  <script>
    // ----- CONSTANTS -----
    const KCAL_PER_KG = 7700;

    const KCAL_PER_CUP = {
      Protein: 120,
      Carbs: 130,
      Veggies: 25,
      Fruits: 65,
      "Healthy Fats": 100,
    };

    function getMinCalories(gender) {
      return gender === "female" ? 1200 : 1500;
    }

    // ----- CORE CALCULATIONS -----
    function calculateBMR(profile) {
      const { gender, weightKg, heightCm, age } = profile;
      if (!weightKg || !heightCm || !age) {
        throw new Error("Missing weight/height/age for BMR calculation.");
      }
      return (
        10 * weightKg +
        6.25 * heightCm -
        5 * age +
        (gender === "female" ? -161 : 5)
      );
    }

    function calculateTDEE(profile) {
      if (!profile.activityFactor) throw new Error("Missing activityFactor.");
      return calculateBMR(profile) * profile.activityFactor;
    }

    function calculateCalorieTarget(profile, pace = "standard") {
      const tdee = calculateTDEE(profile);
      const minCals = getMinCalories(profile.gender);

      let weeklyTargetKg;
      switch (pace) {
        case "gentle":
          weeklyTargetKg = 0.25;
          break;
        case "faster":
          weeklyTargetKg = 0.75;
          break;
        default:
          weeklyTargetKg = 0.5;
      }

      const desiredDailyDeficit = (weeklyTargetKg * KCAL_PER_KG) / 7;
      const maxDeficitByPercent = 0.2 * tdee;
      const maxDeficitAbsolute = 1000;

      let dailyDeficit = Math.min(
        desiredDailyDeficit,
        maxDeficitByPercent,
        maxDeficitAbsolute
      );

      let targetCalories = tdee - dailyDeficit;

      if (targetCalories < minCals) {
        targetCalories = minCals;
        dailyDeficit = Math.max(0, tdee - targetCalories);
      }

      const estimatedWeeklyLossKg = (dailyDeficit * 7) / KCAL_PER_KG;

      return {
        targetCalories: Math.round(targetCalories),
        estimatedWeeklyLossKg,
        dailyDeficit,
        tdee,
      };
    }

    // ----- CUPS PLAN FROM CALORIES -----
    function calculateCupPlan(targetCalories) {
      const split = { Protein: 0.3, Carbs: 0.4, "Healthy Fats": 0.3 };

      const veggieCups =
        targetCalories < 1600 ? 4 : targetCalories < 2200 ? 5 : 6;
      const fruitCups = targetCalories < 1600 ? 2 : 3;

      const proteinCalories = targetCalories * split.Protein;
      const carbCalories = targetCalories * split.Carbs;
      const fatCalories = targetCalories * split["Healthy Fats"];

      let proteinCups = Math.round(
        proteinCalories / KCAL_PER_CUP.Protein
      );
      let carbCups = Math.round(carbCalories / KCAL_PER_CUP.Carbs);
      let fatCups = Math.round(
        fatCalories / KCAL_PER_CUP["Healthy Fats"]
      );

      if (proteinCups < 3) proteinCups = 3;
      if (carbCups < 3) carbCups = 3;
      if (fatCups < 2) fatCups = 2;

      const cups = {
        Protein: proteinCups,
        Carbs: carbCups,
        Veggies: veggieCups,
        Fruits: fruitCups,
        "Healthy Fats": fatCups,
      };

      const macros = {
        proteinCalories: proteinCups * KCAL_PER_CUP.Protein,
        carbCalories: carbCups * KCAL_PER_CUP.Carbs,
        fatCalories: fatCups * KCAL_PER_CUP["Healthy Fats"],
        veggieCalories: veggieCups * KCAL_PER_CUP.Veggies,
        fruitCalories: fruitCups * KCAL_PER_CUP.Fruits,
      };

      return { cups, macros };
    }

    function cupsToCalories(cups) {
      return Object.keys(cups).reduce(
        (sum, key) =>
          sum + (cups[key] || 0) * (KCAL_PER_CUP[key] || 0),
        0
      );
    }

    function calculateDietPlan(profile, pace = "standard") {
      const calorieResult = calculateCalorieTarget(profile, pace);
      const cupsResult = calculateCupPlan(calorieResult.targetCalories);

      return {
        profile,
        pace,
        targetCalories: calorieResult.targetCalories,
        tdee: Math.round(calorieResult.tdee),
        estimatedWeeklyLossKg: calorieResult.estimatedWeeklyLossKg,
        dailyDeficit: Math.round(calorieResult.dailyDeficit),
        cups: cupsResult.cups,
        macros: cupsResult.macros,
      };
    }

    window.PortionlyCalculator = {
      calculateDietPlan,
      calculateBMR,
      calculateTDEE,
      calculateCalorieTarget,
      calculateCupPlan,
      cupsToCalories,
      KCAL_PER_CUP,
    };
  </script>
</body>
</html>
