<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portionly Calculator</title>
</head>
<body>
  <h1>Portionly Calculator Module</h1>
  <p>
    This page just exposes <code>window.PortionlyCalculator</code>.  
    Open the browser console to use it.
  </p>

  <script>
    // ----- CONSTANTS -----

    // Rough energy equivalent of 1 kg of fat (kcal)
    const KCAL_PER_KG = 7700;

    // Approx kcal per "cup" of each group
    const KCAL_PER_CUP = {
      Protein: 120,
      Carbs: 130,
      Veggies: 25,
      Fruits: 65,
      "Healthy Fats": 100,
    };

    // Safe minimum calories per day
    function getMinCalories(gender) {
      // You can tighten these if you want, but don't go lower without medical sign-off
      return gender === "female" ? 1200 : 1500;
    }

    // ----- CORE CALCULATIONS -----

    /**
     * Mifflin-St Jeor BMR in kcal/day
     * profile: { gender: 'female' | 'male', weightKg, heightCm, age }
     */
    function calculateBMR(profile) {
      const { gender, weightKg, heightCm, age } = profile;

      if (!weightKg || !heightCm || !age) {
        throw new Error("Missing weight/height/age for BMR calculation.");
      }

      const base =
        10 * weightKg +
        6.25 * heightCm -
        5 * age +
        (gender === "female" ? -161 : 5);

      return base;
    }

    /**
     * TDEE = BMR * activityFactor
     * profile.activityFactor e.g. 1.2, 1.375, 1.55, 1.725, 1.9
     */
    function calculateTDEE(profile) {
      if (!profile.activityFactor) {
        throw new Error("Missing activityFactor.");
      }
      const bmr = calculateBMR(profile);
      return bmr * profile.activityFactor;
    }

    /**
     * Decide calorie target based on pace.
     * pace: 'gentle' | 'standard' | 'faster'
     * Returns { targetCalories, estimatedWeeklyLossKg, dailyDeficit }
     */
    function calculateCalorieTarget(profile, pace = "standard") {
      const tdee = calculateTDEE(profile);
      const minCals = getMinCalories(profile.gender);

      // Map pace -> rough weekly weight loss target (kg/week)
      let weeklyTargetKg;
      switch (pace) {
        case "gentle":
          weeklyTargetKg = 0.25; // ~0.25 kg/week
          break;
        case "faster":
          weeklyTargetKg = 0.75; // up to ~0.75 kg/week if safe
          break;
        case "standard":
        default:
          weeklyTargetKg = 0.5; // ~0.5 kg/week
          break;
      }

      // Desired daily deficit = weeklyLoss * 7700 / 7
      const desiredDailyDeficit = (weeklyTargetKg * KCAL_PER_KG) / 7;

      // Safety caps: don't go below min calories and don't exceed ~1000 kcal or 20% of TDEE
      const maxDeficitByPercent = 0.2 * tdee;
      const maxDeficitAbsolute = 1000;
      let dailyDeficit = Math.min(
        desiredDailyDeficit,
        maxDeficitByPercent,
        maxDeficitAbsolute
      );

      let targetCalories = tdee - dailyDeficit;

      // Enforce absolute minimum calories
      if (targetCalories < minCals) {
        targetCalories = minCals;
        dailyDeficit = Math.max(0, tdee - targetCalories);
      }

      const estimatedWeeklyLossKg = (dailyDeficit * 7) / KCAL_PER_KG;

      return {
        targetCalories: Math.round(targetCalories),
        estimatedWeeklyLossKg,
        dailyDeficit,
        tdee,
      };
    }

    // ----- CUPS PLAN FROM CALORIES -----

    /**
     * Convert target calories into a cups plan.
     * Returns { cups: {Protein, Carbs, Veggies, Fruits, 'Healthy Fats'}, macros: {...} }
     */
    function calculateCupPlan(targetCalories) {
      // Macro split ranges (rough, not clinical): 25–30% protein, 35–45% carbs, 25–30% fats
      // We'll lock one reasonable split and then adjust cups.
      const split = {
        Protein: 0.3,
        Carbs: 0.4,
        "Healthy Fats": 0.3,
      };

      // Fruits & veggies: scale slightly with total calories
      const veggieCups =
        targetCalories < 1600 ? 4 : targetCalories < 2200 ? 5 : 6;
      const fruitCups = targetCalories < 1600 ? 2 : 3;

      const proteinCalories = targetCalories * split.Protein;
      const carbCalories = targetCalories * split.Carbs;
      const fatCalories = targetCalories * split["Healthy Fats"];

      let proteinCups = Math.round(
        proteinCalories / KCAL_PER_CUP.Protein
      );
      let carbCups = Math.round(carbCalories / KCAL_PER_CUP.Carbs);
      let fatCups = Math.round(
        fatCalories / KCAL_PER_CUP["Healthy Fats"]
      );

      // Some sensible minimums
      if (proteinCups < 3) proteinCups = 3;
      if (carbCups < 3) carbCups = 3;
      if (fatCups < 2) fatCups = 2;

      const cups = {
        Protein: proteinCups,
        Carbs: carbCups,
        Veggies: veggieCups,
        Fruits: fruitCups,
        "Healthy Fats": fatCups,
      };

      // Also return an approximate macro breakdown (helpful if you want to show it later)
      const macros = {
        proteinCalories: proteinCups * KCAL_PER_CUP.Protein,
        carbCalories: carbCups * KCAL_PER_CUP.Carbs,
        fatCalories: fatCups * KCAL_PER_CUP["Healthy Fats"],
        veggieCalories: veggieCups * KCAL_PER_CUP.Veggies,
        fruitCalories: fruitCups * KCAL_PER_CUP.Fruits,
      };

      return { cups, macros };
    }

    // Utility: calculate calories from a cups object
    function cupsToCalories(cups) {
      return Object.keys(cups).reduce(
        (sum, key) =>
          sum + (cups[key] || 0) * (KCAL_PER_CUP[key] || 0),
        0
      );
    }

    // ----- MAIN ENTRY POINT -----
    // profile: {
    //   gender: 'female' | 'male',
    //   weightKg: number,
    //   heightCm: number,
    //   age: number,
    //   activityFactor: number   // 1.2, 1.375, 1.55, 1.725, 1.9...
    // }
    // pace: 'gentle' | 'standard' | 'faster'
    function calculateDietPlan(profile, pace = "standard") {
      const calorieResult = calculateCalorieTarget(profile, pace);
      const cupsResult = calculateCupPlan(
        calorieResult.targetCalories
      );

      return {
        profile,
        pace,
        targetCalories: calorieResult.targetCalories,
        tdee: Math.round(calorieResult.tdee),
        estimatedWeeklyLossKg: calorieResult.estimatedWeeklyLossKg,
        dailyDeficit: Math.round(calorieResult.dailyDeficit),
        cups: cupsResult.cups,
        macros: cupsResult.macros,
      };
    }

    // ----- OPTIONAL: ATTACH TO WINDOW FOR USE IN YOUR EXISTING HTML -----
    window.PortionlyCalculator = {
      calculateDietPlan,
      calculateBMR,
      calculateTDEE,
      calculateCalorieTarget,
      calculateCupPlan,
      cupsToCalories,
      KCAL_PER_CUP,
    };
  </script>
</body>
</html>
