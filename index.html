<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portionly Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: 0 auto;
      line-height: 1.5;
    }

    h1, h2, h3 {
      text-align: center;
    }

    form {
      margin-top: 24px;
      padding: 16px 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .field {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 4px;
    }

    input, select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .inline-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      margin-top: 12px;
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
      cursor: pointer;
    }

    button:hover {
      filter: brightness(0.95);
    }

    #results {
      margin-top: 24px;
      padding: 16px 20px;
      border-radius: 8px;
      background: #fafafa;
      border: 1px solid #eee;
    }

    #error {
      margin-top: 10px;
      color: #b00020;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <img
    src="portionly-logo.png"
    alt="Portionly logo"
    style="max-width:220px; display:block; margin:24px auto 8px;"
  />

  <h1>Portionly Calculator</h1>
  <p style="text-align:center; margin-bottom: 8px;">
    Enter your details to see your daily cups and estimated weight change.
  </p>

  <form id="calculator-form">
    <div class="field">
      <label for="gender">Gender</label>
      <select id="gender" required>
        <option value="female">Female</option>
        <option value="male">Male</option>
      </select>
    </div>

    <div class="field">
      <label for="age">Age (years)</label>
      <input type="number" id="age" min="10" max="100" required />
    </div>

    <div class="field">
      <label for="heightCm">Height (cm)</label>
      <input type="number" id="heightCm" min="120" max="230" required />
    </div>

    <div class="field">
      <label for="weightKg">Weight (kg)</label>
      <input type="number" id="weightKg" min="30" max="300" step="0.1" required />
    </div>

    <div class="field">
      <label for="activityFactor">Activity level</label>
      <select id="activityFactor" required>
        <option value="1.2">Sedentary (little or no exercise)</option>
        <option value="1.375">Lightly active (1–3 days/week)</option>
        <option value="1.55">Moderately active (3–5 days/week)</option>
        <option value="1.725">Very active (6–7 days/week)</option>
        <option value="1.9">Extra active (physical job + training)</option>
      </select>
    </div>

    <div class="field">
      <label>Pace</label>
      <div class="inline-group">
        <label><input type="radio" name="pace" value="gentle" /> Gentle</label>
        <label><input type="radio" name="pace" value="standard" checked /> Standard</label>
        <label><input type="radio" name="pace" value="faster" /> Faster</label>
      </div>
    </div>

    <button type="submit">Calculate plan</button>
    <div id="error" style="display:none;"></div>
  </form>

  <div id="results" style="display:none;">
    <h2>Your plan</h2>
    <p><strong>Daily calories target:</strong> <span id="res-calories"></span> kcal</p>
    <p><strong>Estimated weekly change:</strong> <span id="res-loss"></span></p>
    <p><strong>Daily energy deficit:</strong> <span id="res-deficit"></span> kcal</p>

    <h3>Cups per day</h3>
    <ul id="res-cups"></ul>
  </div>

  <script>
    // ----- CONSTANTS -----
    const KCAL_PER_KG = 7700;

    const KCAL_PER_CUP = {
      Protein: 120,
      Carbs: 130,
      Veggies: 25,
      Fruits: 65,
      "Healthy Fats": 100,
    };

    function getMinCalories(gender) {
      return gender === "female" ? 1200 : 1500;
    }

    // ----- CORE CALCULATIONS -----
    function calculateBMR(profile) {
      const { gender, weightKg, heightCm, age } = profile;
      if (!weightKg || !heightCm || !age) {
        throw new Error("Missing weight/height/age for BMR calculation.");
      }
      return (
        10 * weightKg +
        6.25 * heightCm -
        5 * age +
        (gender === "female" ? -161 : 5)
      );
    }

    function calculateTDEE(profile) {
      if (!profile.activityFactor) throw new Error("Missing activityFactor.");
      return calculateBMR(profile) * profile.activityFactor;
    }

    function calculateCalorieTarget(profile, pace = "standard") {
      const tdee = calculateTDEE(profile);
      const minCals = getMinCalories(profile.gender);

      let weeklyTargetKg;
      switch (pace) {
        case "gentle":
          weeklyTargetKg = 0.25;
          break;
        case "faster":
          weeklyTargetKg = 0.75;
          break;
        default:
          weeklyTargetKg = 0.5;
      }

      const desiredDailyDeficit = (weeklyTargetKg * KCAL_PER_KG) / 7;
      const maxDeficitByPercent = 0.2 * tdee;
      const maxDeficitAbsolute = 1000;

      let dailyDeficit = Math.min(
        desiredDailyDeficit,
        maxDeficitByPercent,
        maxDeficitAbsolute
      );

      let targetCalories = tdee - dailyDeficit;

      if (targetCalories < minCals) {
        targetCalories = minCals;
        dailyDeficit = Math.max(0, tdee - targetCalories);
      }

      const estimatedWeeklyLossKg = (dailyDeficit * 7) / KCAL_PER_KG;

      return {
        targetCalories: Math.round(targetCalories),
        estimatedWeeklyLossKg,
        dailyDeficit,
        tdee,
      };
    }

    // ----- CUPS PLAN FROM CALORIES -----
    function calculateCupPlan(targetCalories) {
      const split = { Protein: 0.3, Carbs: 0.4, "Healthy Fats": 0.3 };

      const veggieCups =
        targetCalories < 1600 ? 4 : targetCalories < 2200 ? 5 : 6;
      const fruitCups = targetCalories < 1600 ? 2 : 3;

      const proteinCalories = targetCalories * split.Protein;
      const carbCalories = targetCalories * split.Carbs;
      const fatCalories = targetCalories * split["Healthy Fats"];

      let proteinCups = Math.round(
        proteinCalories / KCAL_PER_CUP.Protein
      );
      let carbCups = Math.round(carbCalories / KCAL_PER_CUP.Carbs);
      let fatCups = Math.round(
        fatCalories / KCAL_PER_CUP["Healthy Fats"]
      );

      if (proteinCups < 3) proteinCups = 3;
      if (carbCups < 3) carbCups = 3;
      if (fatCups < 2) fatCups = 2;

      const cups = {
        Protein: proteinCups,
        Carbs: carbCups,
        Veggies: veggieCups,
        Fruits: fruitCups,
        "Healthy Fats": fatCups,
      };

      const macros = {
        proteinCalories: proteinCups * KCAL_PER_CUP.Protein,
        carbCalories: carbCups * KCAL_PER_CUP.Carbs,
        fatCalories: fatCups * KCAL_PER_CUP["Healthy Fats"],
        veggieCalories: veggieCups * KCAL_PER_CUP.Veggies,
        fruitCalories: fruitCups * KCAL_PER_CUP.Fruits,
      };

      return { cups, macros };
    }

    function cupsToCalories(cups) {
      return Object.keys(cups).reduce(
        (sum, key) =>
          sum + (cups[key] || 0) * (KCAL_PER_CUP[key] || 0),
        0
      );
    }

    function calculateDietPlan(profile, pace = "standard") {
      const calorieResult = calculateCalorieTarget(profile, pace);
      const cupsResult = calculateCupPlan(calorieResult.targetCalories);

      return {
        profile,
        pace,
        targetCalories: calorieResult.targetCalories,
        tdee: Math.round(calorieResult.tdee),
        estimatedWeeklyLossKg: calorieResult.estimatedWeeklyLossKg,
        dailyDeficit: Math.round(calorieResult.dailyDeficit),
        cups: cupsResult.cups,
        macros: cupsResult.macros,
      };
    }

    // expose in case you still want console use
    window.PortionlyCalculator = {
      calculateDietPlan,
      calculateBMR,
      calculateTDEE,
      calculateCalorieTarget,
      calculateCupPlan,
      cupsToCalories,
      KCAL_PER_CUP,
    };

    // ----- SIMPLE UI WIRING -----
    const form = document.getElementById("calculator-form");
    const resultsEl = document.getElementById("results");
    const errorEl = document.getElementById("error");
    const resCalories = document.getElementById("res-calories");
    const resLoss = document.getElementById("res-loss");
    const resDeficit = document.getElementById("res-deficit");
    const resCups = document.getElementById("res-cups");

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      errorEl.style.display = "none";
      resultsEl.style.display = "none";

      try {
        const gender = document.getElementById("gender").value;
        const age = parseInt(document.getElementById("age").value, 10);
        const heightCm = parseFloat(document.getElementById("heightCm").value);
        const weightKg = parseFloat(document.getElementById("weightKg").value);
        const activityFactor = parseFloat(
          document.getElementById("activityFactor").value
        );
        const pace =
          document.querySelector('input[name="pace"]:checked')?.value ||
          "standard";

        if (!gender || !age || !heightCm || !weightKg || !activityFactor) {
          throw new Error("Please fill in all fields.");
        }

        const profile = {
          gender,
          age,
          heightCm,
          weightKg,
          activityFactor,
        };

        const result = calculateDietPlan(profile, pace);

        const weeklyKg = result.estimatedWeeklyLossKg;
        const weeklyLbs = weeklyKg * 2.20462;

        resCalories.textContent = result.targetCalories.toString();
        resDeficit.textContent = result.dailyDeficit.toString();

        if (weeklyKg > 0) {
          resLoss.textContent =
            "~" +
            weeklyKg.toFixed(2) +
            " kg (" +
            weeklyLbs.toFixed(2) +
            " lb) per week";
        } else {
          resLoss.textContent = "No deficit (maintenance)";
        }

        resCups.innerHTML = "";
        Object.entries(result.cups).forEach(([name, cups]) => {
          const li = document.createElement("li");
          li.textContent = name + ": " + cups + " cups";
          resCups.appendChild(li);
        });

        resultsEl.style.display = "block";
      } catch (err) {
        errorEl.textContent = err.message || "Something went wrong.";
        errorEl.style.display = "block";
      }
    });
  </script>
</body>
</html>
